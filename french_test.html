<!DOCTYPE html>
<html>
  <head>
  <title>French Test</title>
  <script type = "text/javascript" src="jquery-3.6.0.js"></script>
  <script id = "helper"></script>
  <script>
    // force reload of stimuli pages (for development.)
    var stable = "helper_functions.js?="
    var dynamic = Date.now()
    var parent = document.getElementById("helper")
    var someScriptElement = document.createElement("script")
    someScriptElement.setAttribute("src", stable + dynamic)
    helper.appendChild(someScriptElement)
    </script>
  <script src = "jspsych/jspsych.js"></script>
  <script src = 'jspsych/plugin-fullscreen.js'></script>
  <script src = "jspsych/plugin-html-keyboard-response.js"></script>
  <script src = "jspsych/plugin-initialize-microphone.js"></script>
  <script src = "jspsych/plugin-html-audio-response.js"></script>
  <script src = "jspsych/plugin-audio-keyboard-response.js"></script>
  <script src = "jspsych/plugin-audio-button-response.js"></script>
  <script src = "jspsych/plugin-html-button-response.js"></script>
  <script src = "jspsych/plugin-image-button-response.js"></script>
  <script src = "jspsych/plugin-image-keyboard-response.js"></script>
  <script src = "jspsych/plugin-survey-multi-select1.js"></script>
  <script src = "jspsych/plugin-survey-multi-choice1.js"></script>
  <script src = "jspsych/plugin-survey-html-form.js"></script>
  <script src = "jspsych/plugin-survey-html-form-timeout5.js"></script>
  <script src = "jspsych/plugin-instructions.js"></script>
  <script src = "jspsych/plugin-cloze19.js"></script>
  <script src = "jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <link href = "jspsych/jspsych.css" rel="stylesheet" type = "text/css" />
  <script src = 'stimuli.js' type = 'text/javascript'></script>   
  </head>
  <body></body>  
  <script>
  const jsPsych = initJsPsych({
    on_finish: function(data){
      jsPsych.data.displayData();
     // console.log('finished')
      // save data to csv
      saveData(jsPsych.data.get().select('subject').values[0].Q0, jsPsych.data.get().csv())
     // window.location = "https://www.duolingo.com";
    }
  });
  </script>
</html>

<script>
/*version A
- need to create separate data folders for versions A and B, or otherwise figure out how to sort this properly.
*/
const test_version = 'A'
const timeline = []

/* reuse this countdown variable throughout*/
const countdown321 =  {
  // simulate a countdown for recording to start
  type: jsPsychHtmlKeyboardResponse,
  choices: 'NO_KEYS',
  trial_duration: 1050,
  timeline: [
    {stimulus: 'Begin recording in 3...'},
    {stimulus: 'Begin recording in 2...'},
    {stimulus: 'Begin recording in 1...'}
  ]}


  const countdown54321 =  {
  // simulate a countdown for recording to start
  type: jsPsychHtmlKeyboardResponse,
  choices: 'NO_KEYS',
  trial_duration: 1050,
  timeline: [
    {stimulus: 'Begin recording in 5...'},
    {stimulus: 'Begin recording in 4...'},
    {stimulus: 'Begin recording in 3...'},
    {stimulus: 'Begin recording in 2...'},
    {stimulus: 'Begin recording in 1...'}
  ]}

  const five_minute_break = {
    type: jsPsychHtmlButtonResponse, 
    stimulus: 'Before moving on to the next section of the test, please take a short break (up to five minutes).<br><br> Press "Continue" when you are ready to move to the next part of the test.',
    choices:  ["Continue"]
  }

// will be changed to get from URL variable, and also concat it to the test version. 
var get_subject = {
  type: jsPsychSurveyText,
  questions: [{prompt: 'Please enter subject id'}],
  on_finish: function(data){
    jsPsych.data.addProperties({subject: data.response})
    console.log(jsPsych.data.get().select('subject').values[0].Q0)
  }
}
timeline.push(get_subject)

var refresh_warning = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p style = "font-size: 30px; color: red"><b>WARNING</b></p><p>You should set aside at least one hour to complete this test. This test should be completed in one go - you cannot save your data and return later.<br><br>During the test, please <b>do not</b> refresh your browser or use the back button. <br>Doing so will result in a loss of all your data, and will be unable to continue with this project.<br>',
    choices: ['I Understand']
};

timeline.push(refresh_warning)

/* activate microphone and ensure participants can hear themselves being recorded.  */

// explain microphone connection
const prepare_microphone = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p style = "font-size: 30px; color: red"><b>Prepare Microphone</b></p><p>Please connect your microphone to the computer.<br>We recommend using a pair of headphones with a microphone.<br><br>Once you have connected your microphone & headphones to the computer, click this button to prompt browser access to your microphone.<br>',
    choices: ['Add Microphone'],
}
timeline.push(prepare_microphone)

// prompt for permission and initialise microphone
const ready_microphone = {
    type: jsPsychInitializeMicrophone
}
timeline.push(ready_microphone)

// explain to participants they need to make sure they can hear themselves. 
const test_audio_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'Let\'s make sure the test can hear you.<br>Please click the button below and speak into your microphone for a few seconds.<br>Afterwards, you will be able to play your recording.<br><br>Please make sure that you can hear your recording. If not, please make sure you microphone is working properly and try again. <br> Please do not continue the test until you are able to hear a recording of yourself played back to you.<br><br>',
  choices: ['Begin Recording']
}
timeline.push(test_audio_instructions)

// allow recording and playback, recording limited to 10 seconds. 
const test_audio = {
  type: jsPsychHtmlAudioResponse,
    recording_duration: 10000,
    stimulus: 'RECORDING...',
    allow_playback: true,
    show_done_button: true,
    record_again_button_label: 'Record Again',
    on_finish: function(data){
      data.response = 'sanitized'}
}
timeline.push(test_audio)

// honor system - participants will click to move on. 
const recording_passed = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Thank you. You have indicated that you are able to hear yourself in the recording. <br> Press Continue when you are ready to continue the test.',
    choices: ['Continue'],
}
timeline.push(recording_passed);

var enter_fullscreen = {
  type: jsPsychFullscreen,
  fullscreen_mode: true
};

timeline.push(enter_fullscreen);

/***** STORY COMPLETION BLOCK *********
These questions involve participants looking at a series of images with which they will base a story. The images will be displayed for a fixed period of time (30 seconds), after which participants will have 3 minutes to orally tell their story based on the pictures. 

Story Completion Part 1 - single image of a park
- 30 seconds to prepare
- 3 minutes for response
*/
var SC_task_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p  style = "font-size: 30px"><b>Speaking Tasks</b><p class = "instructions">In this next part, you will complete three short speaking tasks.<p class = "instructions">For each task, you will see pictures. Your task is to describe or tell the story based on the pictures. You must use complete sentences. <br><br>But, since, since you\'re in the process of learning French, you can give a list of vocabulary words that you know to describe the picture. You can also use words in English to complete your ideas. But only if you don\'t know the French words! We look forward to hearing your stories!<p>Click "Continue" to move on to the first speaking task.',
  choices: ["Continue"]
}

timeline.push(SC_task_instructions)

var SC1_preload = {
  type: jsPsychPreload,
  images: 'image/PD_1.jpg',
  message: 'Loading...'
}
timeline.push(SC1_preload)

var SC1_instructions = {
type: jsPsychHtmlButtonResponse,
stimulus: '<p style = "font-size: 30px"><b>Picture description task</b><p class = "instructions"><b>Objective</b><br>Describe the people and the activities the people are doing.<br><br><b>Procedure</b><br>You will see an image with many people, doing many activities. You will have 30 seconds to study the image and then 3 minutes to describe what is happening in the image.<br><br> You can focus on: <ul style = "text-align: left"><li>Activities</li><li>People: clothing (color, types), physical traits, likes/dislikes</li><li>Objects (food, vehicles), and their location on the image</li><li>Weather</li></ul>',
choices: ['Continue']
}

timeline.push(SC1_instructions)

var SC1_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response.<br>',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/PD_1.jpg',
      trial_duration: 31000, // should be 30 seconds (30000 ms), add 1000ms (1 second) as buffer
      stimulus_height: 400,
      stimulus_width: 600,
      prompt: '<br><p style = "text-align: left">Remember to describe:</p><ul style = "text-align: left; font-size: 12"><li>People: clothing (color, types), physical traits, likes/dislikes</li><li>Objects (food, vehicles), and their location on the image</li><li>Activities</li><li>Weather</li></ul>',
      on_finish: function(data){
        data.stim_id = 'PD_1'
      },
      choices: ["I'm Ready"]
    },

    // 3 second countdown
    countdown321,

  // record answer 

  {
    type: jsPsychHtmlAudioResponse,
    stimulus: '<img src = "image/PD_1.jpg" width = "600" height = "400"><br><p style = "color:red"><b>RECORDING</b></p><span id = "clock" style = "color:red">-:--</span><p style = "text-align: left"><p>Remember to describe:</p><ul style = "text-align: left; font-size: 12"><li>People: clothing (color, types), physical traits, likes/dislikes</li><li>Objects (food, vehicles), and their location on the image</li><li>Activities</li><li>Weather</li></ul></p>',
    recording_duration: 181000, // trial duration should be 3 minutes (180000ms), add 1000ms as a buffer
    show_done_button: true,
    done_button_label: "Finish Recording",
    
    // countdown timers
    on_load: function(){
      var wait_time = 180000; // 3 minutes in milliseconds
      var start_time = performance.now();
      var interval = setInterval(function(){
        var time_left = wait_time - (performance.now() - start_time);
        var minutes = Math.floor(time_left / 1000 / 60);
        var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
        var seconds_str = seconds.toString().padStart(2,'0');
        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
        // stop timer if button is clicked.
        // listen for the button being clicked to end the trial early.
        var clicked = false
        const btn = document.querySelector('button')
        btn.addEventListener("click", () => {
        //clicked = true
        clearInterval(interval);
        });
        
        // stop the clock!
        if(time_left <= 0){
          clearInterval(interval)
          document.querySelector('#clock').innerHTML = "Time's Up!"
          }
    
    }, 250)},

    // save audio
    on_finish: function(data){
        data.stim_id = 'PD_1';
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
      console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}
timeline.push(SC1_trials)

/* Story Completion Part 2 - six-panel images making a story
- 30 seconds to prepare
- 3 minutes for response
- size images to be w600xh800
- 1 trial so no need for timeline variables. 
*/

var SC2_preload = {
  type: jsPsychPreload,
  images: 'image/narrative_marcus.png',
  message: "Loading..."
}

timeline.push(SC2_preload)

var SC2_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<b style = "font-size: 30px">Story Narration</b><p class = "instructions"><b>Objective</b><br> Tell a story based on 6 images with as many interesting details as you can.<br><br><b>Procedure</b><br>You will see six images. Create an original story using the pictures as a source of inspiration. Provide additional details based on your imagination to make the story more interesting.<br><br>You will have 30 seconds to plan your story and 3 minutes to tell your story. If you forget some words, you can use English.',
  choices: ['Continue']
}
 timeline.push(SC2_instructions)

var SC2_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/narrative_marcus.png',
      prompt: 'Useful vocabulary:<br>&Eacute;chapper = <i>to drop</i><br>Prendre = <i>to take</i>',
      trial_duration: 31000, // should be 30 seconds (30,000 ms), add 1000 ms as buffer
      stimulus_height: 600,
      stimulus_width: 400,
      on_finish: function(data){
        data.stim_id = 'narrative_marcus'},
      choices: ["I'm Ready"]
    },

    // 3 second countdown
    countdown321,

    // record answer 
  {
    type: jsPsychHtmlAudioResponse,
    stimulus: '<img src = "image/narrative_marcus.png" width = "400" height = "600"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>&Eacute;chapper = <i>to drop</i><br>Prendre = <i>to take</i>',
    recording_duration: 181000, // trial duration should be 3 minutes (180000ms), add 500ms as a buffer
    show_done_button: true,
    done_button_label: "Finish Recording",
    // countdown timers
    on_load: function(){
      var wait_time = 180000; // 3 minutes in milliseconds
      var start_time = performance.now();
      var interval = setInterval(function(){
        var time_left = wait_time - (performance.now() - start_time);
        var minutes = Math.floor(time_left / 1000 / 60);
        var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
        var seconds_str = seconds.toString().padStart(2,'0');
        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
        // stop timer if button is clicked.
        // listen for the button being clicked to end the trial early.
        var clicked = false
        const btn = document.querySelector('button')
        btn.addEventListener("click", () => {
        //clicked = true
        clearInterval(interval);
        });
        
        // stop the clock!
        if(time_left <= 0){
          clearInterval(interval)
          document.querySelector('#clock').innerHTML = "Time's Up!"
          }
    }, 250)},
    // save audio
    on_finish: function(data){
        data.stim_id = 'narrative_marcus';
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
      console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}
timeline.push(SC2_trials)

/* Story Completion Part 3 - story of Samantha or Max: before, now, and after.
- 30 seconds to prepare
- 3 minutes to record
*/

var SC3_preload = {
  type: jsPsychPreload,
  images: 'image/samantha1.png',
  message: 'Loading...'
}
timeline.push(SC3_preload)

var SC3_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: ['<p style = "font-size: 30px"><b>Timeline Description Task</b></p><p class = "instructions"><b>Objective</b><br>Tell Samantha\'s Story!<br><br><b>Procedure</b><br> You will see one image. Your task is to tell us what you think happened to Samantha one hour ago, what is happening to Samantha right now, and what will happen next. You will have one minute to plan and three minutes to record your story.<br><br>You story <b>must</b> include: <ol style = "text-align: left"><li>what happened one hour ago</li><li>what is happening now</li><li>what will happen next</li></ol>'],
  choices: ['Continue']
}

timeline.push(SC3_instructions);

var SC3_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response.',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/samantha1.png',
      trial_duration: 31000, // should be 30 seconds (30,000 ms), add 1000 ms as buffer
      stimulus_height: 600,
      stimulus_width: 800,
      choices: ["I'm Ready"],
      on_finish: function(data){
        data.stim_id = 'samantha'
      }
    },
    // 3 second countdown
    countdown321,
  {
    type: jsPsychHtmlAudioResponse,
    stimulus: '<img src = "image/samantha1.png" width = "800" height = "600"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>',
    recording_duration: 181000, // trial duration should be 3 minutes (180000ms), add 1000ms as a buffer
    show_done_button: true,
    done_button_label: "Finish Recording",
    // countdown timers
    on_load: function(){
      var wait_time = 180000; // 3 minutes in milliseconds
      var start_time = performance.now();
      var interval = setInterval(function(){
        var time_left = wait_time - (performance.now() - start_time);
        var minutes = Math.floor(time_left / 1000 / 60);
        var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
        var seconds_str = seconds.toString().padStart(2,'0');
        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
        // stop timer if button is clicked.
        // listen for the button being clicked to end the trial early.
        var clicked = false
        const btn = document.querySelector('button')
        btn.addEventListener("click", () => {
        //clicked = true
        clearInterval(interval);
        });
        
        // stop the clock!
        if(time_left <= 0){
          clearInterval(interval)
          document.querySelector('#clock').innerHTML = "Time's Up!"
          }
    }, 250)},
    // save audio
    on_finish: function(data){
      data.stim_id = 'samantha';
      //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
    console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}

timeline.push(SC3_trials)

/***** COMMUNICATIVE ADEQUACY BLOCK *********
These questions involve participants listening and responding to a sustained simulated conversation. They will listen to the recording and then be asked to record their response. They will only be able to listen to each turn once. 
*/

// allow participants to take a break. 
timeline.push(five_minute_break)

var CA_timeline_stimuli = [
 
/* 
Define all the scenarios
*/

{scenario_num: 'DCT1', scenario: 'You are sick and calling the health clinic to <b>make an appointment</b> with your doctor.<br>The new receptionist is very busy learning her new tasks.<br><br>Start the conversation by:<br>1. Greeting the receptionist.<br>2. Requesting an appointment for tomorrow.<br><br>', reminder: 'Reminder: You are sick and calling the health clinic to <b>make an appointment</b> with your doctor.<br>The new receptionist is very busy learning her new tasks.', turn1: 'audio/1_infirmiere_1_trim.mp3', turn2: 'audio/1_infirmiere_2_trim.mp3', turn3: 'audio/1_infirmiere_3_trim.mp3', data: {stim_id: 'DCT1'}},

  {scenario_num: 'DCT2',scenario: 'You need a ride to school for your exam. The exam is Tuesday at 9h.<br>You call your friend to <b>ask for a ride</b>. Your friend is very tired because he started a new job.<br><br> Start the conversation by:<br>1. Greeting your friend.<br>2. Requesting a ride for Tuesday at 9h.<br><br>', reminder: 'Reminder: You need a ride to school for your exam. The exam is Tuesday at 9h.<br>You call your friend to <b>ask for a ride</b>. Your friend is very tired because he started a new job.', turn1: 'audio/2_auto_1_trim.mp3', turn2: 'audio/2_auto_2_trim.mp3', turn3: 'audio/2_auto_3_trim.mp3', data: {stim_id: 'DCT2'}},

  {scenario_num: 'DCT3',scenario: 'You are taking a French class and you need to practice outside of class for your upcoming exam.<br>You call Madame Janine, a retired French teacher, <b>to ask if you can be her student</b>.<br>Madame Janine has a good reputation and has many students.<br><br>Start the conversation by:<br>1. Greeting Madame Janine.<br>2. Requesting an appointment for a first course.<br><br>', reminder: 'Reminder: You are taking a French class and you need to practice outside of class for your upcoming exam.<br>You call Madame Janine, a retired French teacher, <b>to ask if you can be her student</b>.<br>Madame Janine has a good reputation and has many students. ', turn1: 'audio/3_cours_1_trim.mp3', turn2: 'audio/3_cours_2_trim.mp3', turn3: 'audio/3_cours_3_trim.mp3', data:{stim_id: 'DCT3'}},

  {scenario_num: 'DCT4',scenario: 'Your brother\'s graduation is coming up next weekend. The cake company canceled your order.<br>You <b>ask your best friend to make a cake</b> for the party, but she is sick.<br><br>Start the conversation by:<br>1. Greeting your friend.<br>2. Requesting a cake.<br><br>', reminder: 'Reminder: Your brother\'s graduation is coming up next weekend. The cake company canceled your order.<br>You <b>ask your best friend to make a cake</b> for the party, but she is sick.', turn1: 'audio/4_gateau_1_trim.mp3', turn2: 'audio/4_gateau_2_trim.mp3', turn3: 'audio/4_gateau_3_trim.mp3', data:{stim_id: 'DCT4'}},

  {scenario_num: 'DCT5',scenario: 'You arrive late to your mid-term French exam because you missed the bus.<br><b>You apologize to your professor</b>, Monsieur Jean, for being late.<br>You know how much your teacher hates it!<br><br>Start the conversation by:<br>1. Greeting your teacher Monsieur Jean.<br>2. Apologizing for being late and telling him that you will not arrive late again.<br><br>', reminder: 'Reminder: You arrive late to your mid-term French exam because you missed the bus.<br><b>You apologize to your professor</b>, Monsieur Jean, for being late.<br>You know how much your teacher hates it!', turn1: 'audio/5_retard_1_trim.mp3', turn2: 'audio/5_retard_2_trim.mp3', turn3: 'audio/5_retard_3_trim.mp3', data:{stim_id: 'DCT5'}},
/*
  {scenario_num: 'DCT6',scenario: 'You borrowed your brother\'s car to go to work last night and then went to a concert.<br> You lost your brother\'s car keys somewhere. You call your brother David <b>to apologize</b> and tell him that you will make a copy.<br><br>Start the conversation by:<br>1. Greeting your brother David.<br>2. Apologizing for losing the keys at the concert and telling him that you will make a copy.<br><br>', reminder: 'Reminder: You borrowed your brother\'s car to go to work last night and then went to a concert.<br> You lost your brother\'s car keys somewhere. You call your brother David <b>to apologize</b> and tell him that you will make a copy.', turn1: 'audio/6_cle_1_trim.mp3', turn2: 'audio/6_cle_2_trim.mp3', turn3: 'audio/6_cle_3_trim.mp3', data:{stim_id: 'DCT6'}}
*/
];

var CA_audio = ['audio/1_infirmiere_1_trim.mp3', 'audio/1_infirmiere_2_trim.mp3', 'audio/1_infirmiere_3_trim.mp3', 'audio/2_auto_1_trim.mp3', 'audio/2_auto_2_trim.mp3', 'audio/2_auto_3_trim.mp3', 'audio/3_cours_1_trim.mp3', 'audio/3_cours_2_trim.mp3', 'audio/3_cours_3_trim.mp3', 'audio/4_gateau_1_trim.mp3', 'audio/4_gateau_2_trim.mp3', 'audio/4_gateau_3_trim.mp3', 'audio/5_retard_1_trim.mp3', 'audio/5_retard_2_trim.mp3', 'audio/5_retard_3_trim.mp3', 'audio/6_cle_1_trim.mp3', 'audio/6_cle_2_trim.mp3', 'audio/6_cle_3_trim.mp3']

// response duration max length for DCT (45 seconds + 1000 buffer)
const dct_response_time_max = 46000

// computer response inter trial interval
const computer_response_prompt = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Their response is...',
  trial_duration: 1000
}

var CA_preload = 
{type: jsPsychPreload,
  audio: CA_audio,
  message: "Loading audio, please wait..."
}
timeline.push(CA_preload)

const CA_instructions1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style = "font-size: 30px"><b>Conversation Task</b></p><p class = "instructions"><b>Objective</b><br>To have short, meaningful conversations with a computer simulation.<br><br><b>Procedure</b><br>Carefully read the scenario for each conversation, written in English. For each scenario, you will make four short recordings in French.',
  choices: ['Continue Instructions']
}

timeline.push(CA_instructions1)

const CA_instructions2 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p class = "instructions">Based on the written scenario, you will begin the conversation. After your first recording, you will hear a computer-generated reply. You will have the option to replay the reply one time. You will then record a response to that reply. This back and forth will continue for two more responses for each conversation.<br><br> Please continue to see an example.',
  choices: ["Continue"]
}

timeline.push(CA_instructions2)

const CA_example = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p class = "instructions"><b>Example</b><br>Below is an example (in English) demonstrating how you should complete these conversations. Please take a moment to study the example. You will be hearing and recording your own answers <b>in French</b> for each conversation in the same format as this example.</p>' +

  '<p class = "instructions"><b>Scenario</b><br> You are working on a group project and one member did not finish her part. You call her to tell her that you are upset.</p>'

  +
    
    
    '<table><tr><th colspan = "2">Conversation Order</th><th colspan = "4">Example Conversation</th></tr>' +
    
    '<tr><td colspan = "2"><span style = "color:red">1. Start the conversation</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>Hey Michelle. You did not send me your part and I had to do it. You were supposed to send it last night.</td></tr>' +
    
    '<tr><td colspan = "2">2. You will hear:</td><td colspan = "3">I\'m sorry. I got really sick, and couldn\'t finish it. What part should I do then?</td></tr>' +
    
    '<tr><td colspan = "2"><span style = "color:red">3. Record your reply</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>Can you please do the conclusion?</td></tr>' + 
    
    '<tr><td colspan = "2">4. You will hear:</td><td colspan = "3">When should I send it?</td></tr>' +
    
    '<tr><td colspan = "2"><span style = "color:red">5. Record your reply</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>You should send it to me by tomorrow.</td></tr>' +
    
    '<tr><td colspan = "2">6. You will hear:</td><td colspan = "3">Ok, will do!</td></tr>'
    +
    
    '<td colspan = "2"><span style = "color:red">Record your closing</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>Great, thank you!</td></tr></table><br>',
  choices: ["I'm Ready"]
}

timeline.push(CA_example)

// communicative adequacy timeline. 
const CA_trials = {
  timeline: [
  {type: jsPsychHtmlButtonResponse,
  stimulus: 'You are about to begin a new conversation.<br><br>',
  choices: ['Begin Conversation']},

{
  type: jsPsychHtmlButtonResponse,
  stimulus: jsPsych.timelineVariable('scenario'),
  choices: ['Start your conversation...']
},

  // 3 second countdown
  countdown321,

  // record conversation opening
{
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'.concat(jsPsych.timelineVariable('reminder'))
    },
    stimulus: '',
    recording_duration: dct_response_time_max,
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    // countdown timers
    on_load: function(){
      var wait_time = dct_response_time_max - 1000;
      var start_time = performance.now();
      var interval = setInterval(function(){
        var time_left = wait_time - (performance.now() - start_time);
        var minutes = Math.floor(time_left / 1000 / 60);
        var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
        var seconds_str = seconds.toString().padStart(2,'0');
        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
         // stop timer if button is clicked.
        // listen for the button being clicked to end the trial early.
        var clicked = false
        const btn = document.querySelector('button')
        btn.addEventListener("click", () => {
        //clicked = true
        clearInterval(interval);
        });
        
        // stop the clock!
        if(time_left <= 0){
          clearInterval(interval)
          document.querySelector('#clock').innerHTML = "Time's Up!"
          }
    }, 250)},
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.timelineVariable('scenario_num').concat('_1_conversation_opening'),
      data)
}},

computer_response_prompt,

{
    timeline: [{
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('turn1'),
      choices: ['Play one more time', 'Continue'],
      response_allowed_while_playing: false,
      on_start: function(trial){
        if(jsPsych.data.getLastTrialData().values()[0].trial_type == 'html-keyboard-response'){
          trial.choices = ['Play one more time', 'Continue']
        } else {
          trial.choices = ['Continue']
        }
      }
    }], 

    loop_function: function(data){
      // check what previous trial was to determine if trial can be replayed
      if(data.values()[0].response == 0 && jsPsych.data.get().last(2).values()[0].trial_type == 'html-keyboard-response'){
          return true; // loop again!
      } else {
          return false; // continue
      }
    }
  },

  // 5 second countdown
  countdown321,

  // record answer to first turn.
{
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'
    },
    stimulus: '',
    recording_duration: dct_response_time_max, 
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    on_load: function(){
      var wait_time = dct_response_time_max - 1000;
      var start_time = performance.now();
      var interval = setInterval(function(){
        var time_left = wait_time - (performance.now() - start_time);
        var minutes = Math.floor(time_left / 1000 / 60);
        var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
        var seconds_str = seconds.toString().padStart(2,'0');
        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
         // stop timer if button is clicked.
        // listen for the button being clicked to end the trial early.
        var clicked = false
        const btn = document.querySelector('button')
        btn.addEventListener("click", () => {
        //clicked = true
        clearInterval(interval);
        });
        
        // stop the clock!
        if(time_left <= 0){
          clearInterval(interval)
          document.querySelector('#clock').innerHTML = "Time's Up!"
          }
    }, 250)},
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.timelineVariable('scenario_num').concat('_2_first_response'),
      // current js data object
      data)
}},
    
computer_response_prompt,

{
    timeline: [{
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('turn2'),
      choices: ['Play one more time', 'Continue'],
      response_allowed_while_playing: false,
      on_start: function(trial){
        if(jsPsych.data.getLastTrialData().values()[0].trial_type == 'html-keyboard-response'){
          trial.choices = ['Play one more time', 'Continue']
        } else {
          trial.choices = ['Continue']
        }
      }
    }],
    loop_function: function(data){
      // check what previous trial was to determine replays
      if(data.values()[0].response == 0 && jsPsych.data.get().last(2).values()[0].trial_type == 'html-keyboard-response'){
          return true; // loop again!
      } else {
          return false; // continue
      }
    }
  },

  // 5 second countdown
  countdown321,

   // record answer trial to second turn
   {
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'
    },
    stimulus: '',
    recording_duration: dct_response_time_max,
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    on_load: function(){
      var wait_time = dct_response_time_max - 1000;
      var start_time = performance.now();
      var interval = setInterval(function(){
        var time_left = wait_time - (performance.now() - start_time);
        var minutes = Math.floor(time_left / 1000 / 60);
        var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
        var seconds_str = seconds.toString().padStart(2,'0');
        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
         // stop timer if button is clicked.
        // listen for the button being clicked to end the trial early.
        var clicked = false
        const btn = document.querySelector('button')
        btn.addEventListener("click", () => {
        //clicked = true
        clearInterval(interval);
        });
        
        // stop the clock!
        if(time_left <= 0){
          clearInterval(interval)
          document.querySelector('#clock').innerHTML = "Time's Up!"
          }
    }, 250)},
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
     jsPsych.timelineVariable('scenario_num').concat('_3_second_response'),
      // current js data object
      data)
}},

computer_response_prompt,

{
    timeline: [{
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('turn3'),
      choices: ['Listen one more time', 'Continue'],
      response_allowed_while_playing: false,
      on_start: function(trial){
        if(jsPsych.data.getLastTrialData().values()[0].trial_type == 'html-keyboard-response'){
          trial.choices = ['Play one more time', 'Continue']
        } else {
          trial.choices = ['Continue']
        }
      }
    }],
    loop_function: function(data){
      // check what previous trial was to determine replays
      if(data.values()[0].response == 0 && jsPsych.data.get().last(2).values()[0].trial_type == 'html-keyboard-response'){
          return true; // loop again!
      } else {
          return false; // continue
      }
    }
  },

  // 5 second countdown
  countdown321,

     // record answer to third turn
     {
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'
    },
    stimulus: '',
    recording_duration: 45000, //
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    on_load: function(){
      var wait_time = dct_response_time_max - 1000;
      var start_time = performance.now();
      var interval = setInterval(function(){
        var time_left = wait_time - (performance.now() - start_time);
        var minutes = Math.floor(time_left / 1000 / 60);
        var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
        var seconds_str = seconds.toString().padStart(2,'0');
        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
        // stop timer if button is clicked.
        // listen for the button being clicked to end the trial early.
        var clicked = false
        const btn = document.querySelector('button')
        btn.addEventListener("click", () => {
        //clicked = true
        clearInterval(interval);
        });
        
        
        // stop the clock!
        if(time_left <= 0){
          clearInterval(interval)
          document.querySelector('#clock').innerHTML = "Time's Up!"
          }
    }, 250)},
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.timelineVariable('scenario_num').concat('_4_conversation_ending'),
      // current js data object
      data)
}},

  {type: jsPsychHtmlKeyboardResponse,
  stimulus: "Loading next conversation...",
  trial_duration: 2500,
  choices: "NO_KEYS"
  }
 ], timeline_variables: CA_timeline_stimuli, randomize_order: true}

timeline.push(CA_trials)

/***** C-TEST *********
Participants will read three short texts. Each text will have some words missing parts of the word. Participants must type in letters in order to provide correct words. 
*/

var french_keyboard = '<p style = "font-size:14px; text-align:center; border:dotted; width:500px;margin:auto">If your keyboard does not have French accents, please use these numbers to replace the appropriate letter with the corresponding number:<br>1 = &agrave;&emsp;&emsp;&emsp;2 = &eacute;&emsp;&emsp;&emsp;3 = &ecirc;&emsp;&emsp;&emsp;4 = &egrave;<br>Example: For the word <b>&eacute;cole</b>, please type it as <b>2cole</b><br><i>Please type in the missing letters to complete the words.</i></p><br>'

var CT_stim = [
    {
    c_text: french_keyboard.concat('Bonjour, je m\'appelle Marise et j\'ai un animal de compagnie!<p>I%% est bl%%, brun, e%%, tr&egrave;s pe%%. Mon a%% a d%% belles orei%%.<p>El%% sont lon%%. <p>Le ma%%, je l%% donne d%% la nourr%%.<p>Il ma%% ses caro%% tr&egrave;s rapid%%! <p>Mon a%% sp&eacute;cial n\'a%% pas l%% chiens, ma%% il ad%% les enf%%.<p>Tu as devin&eacute;, mon ami c\'est un lapin.'), data: {stim_id: 'CTEST_1'}
},
{
    c_text: french_keyboard.concat("Coucou, tu es d\'accord pour m\'aider &agrave; organiser l\'anniversaire de Clara?<p>La f&ecirc;%% est sam%% chez m%%.<p>Nous av%% un exce%% g&acirc;teau a%% chocolat e%% mon fr%% a l%% d&eacute;corations <br>e%% la mu%%.<p>Viens av%% ton cop%%. On v%% pr&eacute;parer u%% grosse sal%% de fru%% ensemble.<p> Appelle-moi quand vous arrivez."), data: {stim_id: 'CTEST_2'}
},
{
    c_text: french_keyboard.concat("Un livre qui pr&eacute;tend introduire des aspects de la culture fran√ßaise ne serait pas complet sans un chapitre sur les beaux-arts.<p>En fa%%, de nomb%% touristes vo%% en Fra%% dans l\'inte%% d\'admirer s%% chefs-d\'&oelig;u%% de pein%%, d\'archit%% et d%% sculpture.<p>Q%% n\'a p%% entendu par%% du Louvre? d%% la cath%% Notre-Dame d%% Paris? des scul%% de Rodin?<p>Nous ne pouvons pas vous pr&eacute;senter une &eacute;tude en profondeur des beaux-arts en France."), data: {stim_id: 'CTEST_3'}
},

]

// allow participants to take a break. 
timeline.push(five_minute_break)

var CT_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style = "font-size: 30px"><b> Word Completion Task</b></p><p class = "instructions"><b>Objective</b><br>To fill in missing parts of a word to make texts complete.<br><br><b>Procedure</b><br> In the following texts, parts of some words are missing. Please type in the missing letters to complete the words. You will have 5 minutes for each text.<br><br>Do your best to not leave any spaces blank!',
choices: ['Continue']
}

timeline.push(CT_instructions);
// in case we want to REQUIRE answers 
// https://github.com/jspsych/jsPsych/discussions/2543


var CT_trials = {
timeline:[
{type: jsPsychHtmlButtonResponse,
stimulus: 'Press "Continue" to see the text.',
choices: ['Continue'],
},

{type: jsPsychCloze,
text: jsPsych.timelineVariable('c_text'),
data: jsPsych.timelineVariable("data"),
trial_duration: 301000,
button_text: '<br>Submit Answers</b>'
}
], timeline_variables: CT_stim, randomize_order: false
}

timeline.push(CT_trials);

/***** ERROR CORRECTION TASK *********
Participants will see a sentence and also hear the sentence spoken one time
They will know there is an error somewhere in the sentence
Their task is to locate and correct the error
*/

EC_timeline_stimuli = [
  {sentence: 'Julian pr&eacute;pare les tomates rouge pour la salade.', 
  audio: 'audio/EC/EC1_trim.mp3', 
  data: {stim_id: 'EC1'}
  },
  {sentence: 'Pour c&eacute;l&eacute;brer la f&ecirc;te de Paola, ils allent au restaurant.', 
  audio: 'audio/EC/EC2_trim.mp3', 
  data: {stim_id: 'EC2'}
  },
  {sentence: 'Tu fait souvent du v&eacute;lo de montagne avec ton cousin.', 
  audio: 'audio/EC/EC3_trim.mp3', 
  data: {stim_id: 'EC3'}
  },
  {sentence: 'David et Laurence sont lou&eacute; une chambre d\'h&ocirc;tel au centre-ville. ', 
  audio: 'audio/EC/EC4_trim.mp3', 
  data: {stim_id: 'EC4'}
  },
  {sentence: 'Madame Zuniga habites sur le campus de l\'universit&eacute;.', 
  audio: 'audio/EC/EC5_trim.mp3', 
  data: {stim_id: 'EC5'}
  },
  {sentence: 'Elle a trouver un ballon de foot pour l\'anniversaire de Marwan.', 
  audio: 'audio/EC/EC6_trim.mp3', 
  data: {stim_id: 'EC6'}
  },
  {sentence: 'Ils ne trouvent pas une grande maison &agrave; Boston.  ', 
  audio: 'audio/EC/EC7_trim.mp3', 
  data: {stim_id: 'EC7'}
  },
  {sentence: 'Ta fr&egrave;re travaille toute la journ&eacute;e au bureau. ', 
  audio: 'audio/EC/EC9_trim.mp3', 
  data: {stim_id: 'EC9'}
  },
  {sentence: 'Nous jouons au tennis avec un raquette et une balle.', 
  audio: 'audio/EC/EC11_trim.mp3', 
  data: {stim_id: 'EC11'}
  },
  {sentence: 'Vous finis vos devoirs avant de jouer avec vos copains!', 
  audio: 'audio/EC/EC12_trim.mp3', 
  data: {stim_id: 'EC12'}
  },
  {sentence: 'Elisabeth aime la petit plante dans la cuisine.', 
  audio: 'audio/EC/EC13_trim.mp3', 
  data: {stim_id: 'EC13'}
  },
  {sentence: 'Magali explique la nouvelle le&ccedil;on &agrave; les &eacute;tudiants.', 
  audio: 'audio/EC/EC14_trim.mp3', 
  data: {stim_id: 'EC14'}
  },
  {sentence: 'J\'ai chaud. Je veut une glace au chocolat et &agrave; la vanille.', 
  audio: 'audio/EC/EC15_trim.mp3', 
  data: {stim_id: 'EC15'}
  },
  {sentence: 'J\'adore la nouvelle professeure de fran&ccedil;ais de ton s&oelig;ur.', 
  audio: 'audio/EC/EC16_trim.mp3', 
  data: {stim_id: 'EC16'}
  },
  {sentence: 'Les enfants de Max et Laurent grandissez tr&egrave;s rapidement.', 
  audio: 'audio/EC/EC17_trim.mp3', 
  data: {stim_id: 'EC17'}
  },
  {sentence: 'Chaque matin, nous boire un th&eacute; sur la terrasse.', 
  audio: 'audio/EC/EC18_trim.mp3', 
  data: {stim_id: 'EC18'}
  },
  {sentence: 'Le weekend, on regardent la t&eacute;l&eacute;vision avec notre famille.', 
  audio: 'audio/EC/EC20_trim.mp3', 
  data: {stim_id: 'EC20'}
  }
]

// yes this bad programming.
var EC_audio = ['audio/EC/EC1_trim.mp3', 'audio/EC/EC2_trim.mp3', 'audio/EC/EC3_trim.mp3','audio/EC/EC4_trim.mp3','audio/EC/EC5_trim.mp3','audio/EC/EC6_trim.mp3','audio/EC/EC7_trim.mp3','audio/EC/EC8_trim.mp3','audio/EC/EC9_trim.mp3','audio/EC/EC10_trim.mp3','audio/EC/EC11_trim.mp3','audio/EC/EC12_trim.mp3','audio/EC/EC13_trim.mp3','audio/EC/EC14_trim.mp3','audio/EC/EC15_trim.mp3','audio/EC/EC16_trim.mp3','audio/EC/EC17_trim.mp3','audio/EC/EC18_trim.mp3','audio/EC/EC19_trim.mp3','audio/EC/EC20_trim.mp3',]

var EC_preload = {
  type: jsPsychPreload,
  audio: EC_audio
}

timeline.push(EC_preload);


// allow participants to take a break. 
timeline.push(five_minute_break)

var EC_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style = "font-size: 30px"><b>Error Correction Task</b></p><p class = "instructions"><b>Objective</b><br>Locate and correct grammatical errors in French sentences.<br><br><b>Procedure</b><br>You will see a series of sentences, one at a time. When you are shown each sentence, you will also hear the sentence being read. The written version of the sentence will remain on the screen.<br><br>Each sentence will contain <b>one</b> grammatical error. Your goal is to (1) identify the error and (2) correct the error. You will have 2 minutes for each sentence.',
choices: ['Continue to Example']
}

timeline.push(EC_instructions);

EC_prompts = [{prompt: 'What is the error?', required: true}, 
{prompt: 'What is the correction?', required: true}]


// removed need to explain the error {prompt: 'Why is it an error?', required: true}]

EC_demo_html = '<p>What is the error? <input readonly type = "text" id = "demo_error" name = "demo_response" placeholder = "on"/></p>' +
'<p>What is the correction? <input readonly type = "text" id = "demo_correction" name = "demo_response" placeholder = "at"/></p>'

/*
'<p>Why is it an error? <input readonly type = "text" id = "demo_explanation" name = "demo_response" placeholder = "wrong preposition choice" size = "50"/></p>'
*/

EC_html = '<p>What is the error? <input type = "text" name = "error"/></p><p>What is the correction? <input type = "text" name = "correction"/></p>'

/*
<p>Why is it an error? <input type = "text" name = "explanation" size = "50"/></p>'
*/

var EC_demo = {
  timeline:[
  {type: jsPsychSurveyHtmlForm,
  html: EC_demo_html,
  preamble: '<i>Please follow this example when answering the questions.<br>Press continue when you are ready to begin.</i><br><br><br><b>The students are meeting on the library at 5pm.</b><br><br>'
},
{type: jsPsychHtmlButtonResponse,
  stimulus: 'Provide as many answers as you can. Do not give up!<br><br>Do not use online dictionaries or reference tools.<br><br>We are interested in what <i>you</i> know!',
  choices:['Begin']
}
]
}

timeline.push(EC_demo);

var EC_trials = {
  timeline:[

  {type: jsPsychHtmlButtonResponse,
    stimulus: 'Click Next to proceed to the next sentence.<br>',
    choices: ["Next"]},

  {type: jsPsychSurveyHtmlFormTO,
  data: jsPsych.timelineVariable('data'),
  on_start: function(trial){
  trial.preamble = '<audio autoplay><source src ='.concat(jsPsych.timelineVariable('audio')).concat('></audio>').concat('<b>').concat(jsPsych.timelineVariable('sentence').concat('</b><br><br>'))
  },
  html: EC_html,
  preamble: '',
  trial_duration: 121000 //duration of each question is 2 minutes 1000ms buffer
  },
  
], timeline_variables: EC_timeline_stimuli, randomize_order: true
}

timeline.push(EC_trials)

 var end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Press the spacebar to end the test',
  choices: ' '
 }
 
timeline.push(end)
 

jsPsych.run(timeline);
</script>